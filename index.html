<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury Fashion Data Story</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
</head>
<body>
    <!-- EMPTY container: slides will be injected by slides/*.js -->
    <div class="scroll-container"></div>

    <!-- Load slide modules (inject HTML into .scroll-container) -->
    <script src="slides/slide1.js"></script>
    <script src="slides/slide1_5.js"></script>
    <script src="slides/slide2.js"></script>
    <script src="slides/slide3.js"></script>
    <script src="slides/slide4.js"></script>
    <script src="slides/slide5.js"></script>
    <script src="slides/slide6.js"></script>
    <script src="slides/slide7.js"></script>
    <script src="slides/slide7_5.js"></script>
    <script src="slides/slide8.js"></script>
    <script src="slides/slide8_5.js"></script>
    <script src="slides/slide9.js"></script>
    <script src="slides/slide10.js"></script>
    <script src="slides/slide11.js"></script>
    <script src="slides/slide12.js"></script>
    <script src="slides/slide13.js"></script>
    <script src="slides/slide14.js"></script>
    <script src="slides/slide15.js"></script>
    <script src="slides/slide16.js"></script>
    <script src="slides/slide17.js"></script>
    <script src="slides/slide18.js"></script>
    <script src="slides/slide19.js"></script>

    <!-- Tooltip -->
    <div class="tooltip"></div>

    <script>
        // Luxury Brands Chart Visualization
        const tooltip = d3.select(".tooltip");

        async function createLuxuryBrandsChart() {
            try {
                const rawData = await d3.csv("data/Top leading luxury brands.csv");
                
                // Parse the data (skip header rows and clean)
                const data = rawData
                    .filter(d => d['Most valuable global luxury brands 2025'] && 
                                 d['Most valuable global luxury brands 2025'].includes(' '))
                    .map(d => {
                        const text = d['Most valuable global luxury brands 2025'];
                        const parts = text.split(' ');
                        const country = parts[parts.length - 1];
                        const brand = parts.slice(0, -1).join(' ');
                        const value = parseFloat(d[''].replace(/,/g, ''));
                        return { brand, country, value };
                    })
                    .filter(d => !isNaN(d.value))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                const totalValue = d3.sum(data, d => d.value);

                const width = 550;
                const height = 550;
                const radius = Math.min(width, height) / 2;

                const svg = d3.select("#luxuryBrandsChart")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${width / 2}, ${height / 2})`);

                // Color scale with gold and earth tones
                const colorScale = d3.scaleOrdinal()
                    .domain(data.map(d => d.brand))
                    .range([
                        '#d4af37', '#c9a961', '#bfa47a', '#b89f6f',
                        '#a89968', '#9a8f5e', '#8d8556', '#8b7d6b',
                        '#7a6f4d', '#6b6142'
                    ]);

                const pie = d3.pie()
                    .value(d => d.value)
                    .sort(null);

                const arc = d3.arc()
                    .innerRadius(radius * 0.4)
                    .outerRadius(radius * 0.85);

                const arcHover = d3.arc()
                    .innerRadius(radius * 0.4)
                    .outerRadius(radius * 0.88);

                // Draw arcs
                const arcs = svg.selectAll(".brand-arc")
                    .data(pie(data))
                    .join("path")
                    .attr("class", "brand-arc")
                    .attr("fill", d => colorScale(d.data.brand))
                    .attr("stroke", "#0a0a0a")
                    .attr("stroke-width", 2)
                    .style("opacity", 0)
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("d", arcHover);
                        
                        const percentage = ((d.data.value / totalValue) * 100).toFixed(1);
                        tooltip
                            .style("opacity", 1)
                            .html(`
                                <strong>${d.data.brand}</strong><br/>
                                Value: $${d.data.value.toFixed(1)}B<br/>
                                Country: ${d.data.country}<br/>
                                Market Share: ${percentage}%
                            `)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mousemove", function(event) {
                        tooltip
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("d", arc);
                        
                        tooltip.style("opacity", 0);
                    });

                // Animate arcs in with stagger
                arcs.transition()
                    .duration(800)
                    .delay((d, i) => i * 80)
                    .style("opacity", 1)
                    .attrTween("d", function(d) {
                        const interpolate = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                        return function(t) {
                            return arc(interpolate(t));
                        };
                    });

                // Center circle
                svg.append("circle")
                    .attr("class", "center-circle")
                    .attr("r", radius * 0.38)
                    .style("opacity", 0)
                    .transition()
                    .delay(500)
                    .duration(600)
                    .style("opacity", 1);

                // Center text
                svg.append("text")
                    .attr("class", "center-value")
                    .attr("y", -10)
                    .text(`$${(totalValue / 1000).toFixed(1)}B`)
                    .style("opacity", 0)
                    .transition()
                    .delay(800)
                    .duration(600)
                    .style("opacity", 1);

                svg.append("text")
                    .attr("class", "center-label")
                    .attr("y", 15)
                    .text("TOP 10 BRANDS")
                    .style("opacity", 0)
                    .transition()
                    .delay(800)
                    .duration(600)
                    .style("opacity", 1);

            } catch (error) {
                console.error("Error loading luxury brands data:", error);
            }
        }

        // Expose to global scope
        window.createLuxuryBrandsChart = createLuxuryBrandsChart;
    </script>

    <script>
        // Scroll Navigation
        function scrollToSlide(index) {
            const allSlides = document.querySelectorAll('.slide');
            allSlides[index].scrollIntoView({ behavior: 'smooth' });
        }

        // Add bottom navigation buttons to all slides except the last
        setTimeout(() => {
            const allSlides = document.querySelectorAll('.slide');
            allSlides.forEach((slide, index) => {
                if (index < allSlides.length - 1) {
                    const btn = document.createElement('div');
                    btn.className = 'next-slide-btn';
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d4af37" stroke-width="2"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>';
                    btn.onclick = () => scrollToSlide(index + 1);
                    slide.appendChild(btn);
                }
            });
        }, 500);

        // Update slide visibility on scroll
        const scrollContainer = document.querySelector('.scroll-container');

        scrollContainer.addEventListener('scroll', () => {
            const scrollPosition = scrollContainer.scrollTop;
            const windowHeight = window.innerHeight;
            const allSlides = document.querySelectorAll('.slide');

            allSlides.forEach((slide, index) => {
                const slideTop = slide.offsetTop;
                const slideBottom = slideTop + slide.offsetHeight;

                if (scrollPosition >= slideTop - windowHeight / 2 && scrollPosition < slideBottom - windowHeight / 2) {
                    const content = slide.querySelector('.slide-content');
                    if (content && !content.classList.contains('visible')) {
                        content.classList.add('visible');
                    }
                }
            });
        });

        // Initialize first slide
        setTimeout(() => {
            const firstContent = document.querySelector('.slide-content');
            if (firstContent) firstContent.classList.add('visible');
        }, 100);

        // Brand colors (styling constants - OK to keep in JS)
        window.brandColors = {
            "Hermès": "#8B2635",
            "Gucci": "#d4af37",
            "Coach": "#8b4513"
        };

        // Load data from CSV files instead of hard-coding
        Promise.all([
            d3.csv('data/revenue_data.csv', d => ({
                Year: +d.Year,
                "Hermès": +d["Hermès"],
                Gucci: +d.Gucci,
                Coach: +d.Coach
            })),
            d3.csv('data/resale_data.csv', d => ({
                brand: d.brand,
                category: d.category,
                count: +d.count,
                mean: +d.mean
            }))
        ]).then(([revenueData, resaleData]) => {
            // Store data globally
            window.revenueData = revenueData;
            window.resaleData = resaleData;

            console.log('✅ Data loaded successfully from CSV files');
            console.log('Revenue data:', revenueData);
            console.log('Resale data:', resaleData);

            // Initialize observers after data loads
            initializeObservers();
        }).catch(error => {
            console.error('❌ Error loading data from CSV files:', error);
            alert('Failed to load data. Please make sure CSV files exist in the data/ folder.');
        });

        // Initialize visualizations when slides become visible
        function initializeObservers() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const slideContent = entry.target.querySelector('.slide-content');
                        if (slideContent && !slideContent.classList.contains('visible')) {
                            slideContent.classList.add('visible');
                        }

                        if (entry.target.classList.contains('intro-slide') && !entry.target.dataset.initialized) {
                            if (window.createLuxuryBrandsChart) window.createLuxuryBrandsChart();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-3') && !entry.target.dataset.initialized) {
                            if (window.createBrandTimeline) window.createBrandTimeline();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-6') && !entry.target.dataset.initialized) {
                            if (window.createOverviewChart) window.createOverviewChart();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-6-5') && !entry.target.dataset.initialized) {
                            if (window.createStreamgraph) window.createStreamgraph();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-7') && !entry.target.dataset.initialized) {
                            if (window.createGlobalTrafficViz) window.createGlobalTrafficViz();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-7-5') && !entry.target.dataset.initialized) {
                            if (window.createWorldMap) window.createWorldMap();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-9') && !entry.target.dataset.initialized) {
                            if (window.loadProducts) window.loadProducts();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-10') && !entry.target.dataset.initialized) {
                            if (window.createDistributionChart) window.createDistributionChart();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-12') && !entry.target.dataset.initialized) {
                            if (window.createResaleChart) window.createResaleChart();
                            entry.target.dataset.initialized = true;
                        }
                        if (entry.target.classList.contains('slide-vestiaire') && !entry.target.dataset.initialized) {
                            if (window.createVestiaireViz) window.createVestiaireViz();
                            entry.target.dataset.initialized = true;
                        }
                    }
                });
            }, { threshold: 0.3 });

            const observedSlides = document.querySelectorAll('.slide');
            observedSlides.forEach(slide => observer.observe(slide));
        }
    </script>
</body>
</html>
